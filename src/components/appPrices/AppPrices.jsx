import React, { useEffect, useState } from 'react'
import { Tabel } from '../Tabel'
import clsx from 'clsx'
import toast from 'react-hot-toast'
import Cookies from 'js-cookie';
import axios from 'axios'
import { baseUrl } from '../../constants/baseUrl'
import { OrdersContext } from '../../hooks/UseContext'
import CircularProgress from "@mui/material/CircularProgress";
import ModalPob from '../Modals/Modal'
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { appsPricesColumns } from '../../constants/data';


export default function AppPrices({ id, name }) {

  const [dataPrices, setDataPrices] = useState()

  const [submit, setSubmit] = useState(false)
  const [open, setOpen] = useState(false);

  const [unitFile, setUnitFile] = useState()
  const [fileSet, setFileSet] = useState(false)
  const [fileValue, setFileValue] = useState()
  const [error, setError] = useState(false)

  const handleClose = () => {
    setOpen(false)
  }
  const handleOpen = () => {
    setOpen(true)
  }



  const fetchData = async () => {
    await axios.request(
      {
        url: `${baseUrl}apps/prices/${id}`,
        method: "get",
        headers: {
          "Accept": "application/json",
          Authorization: `Bearer ${Cookies.get('token')}`,
        }
      }
    ).then((res) => {
      setDataPrices(res.data)
    })
      .catch(e => {
        toast.error("Faild to fetch data")
        setError(true)
      })
  }

  const handleUpadteProviders = async (e) => {
    e.preventDefault()
    setSubmit(true)
    const data = new FormData()
    data.append("file", unitFile)


    await axios.request({
      url: `${baseUrl}apps/prices/import/${id}`,
      method: "post",
      headers: {
        "Accept": "application/json",
        Authorization: `Bearer ${Cookies.get('token')}`,
      },
      data: data
    })
      .then(res => {
        toast.success("تم رفع الملف الجديد بنجاح")
        fetchData()
        handleClose()
        setSubmit(false)
        setFileValue("")
        setUnitFile("")
        setFileSet(false)
      })
      .catch(e => {
        toast.error("فشلت العملية")
        handleClose()
        setSubmit(false)
        setFileValue("")
        setUnitFile("")
        setFileSet(false)
      })

  }

  const handleDownload = async () => {
    setSubmit(true)

    await fetch(`${baseUrl}apps/prices/export/${id}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        'Authorization': `Bearer ${Cookies.get('token')}`,
      }
    }).then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok ' + response.statusText);
      }
      return response.blob();
    })
      .then(blob => {

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${`${name}-app-prices.xlsx`}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setSubmit(false)
      })
      .catch(error => {
        setSubmit(false)
        console.log(error);
      });

  }

  useEffect(() => {
    fetchData()
  }, [])
  return (
    <div className='h-[500px] w-[700px] overflow-y-scroll pr-2'>

      <h1 className="text-2xl lg:text-[32px] font-bold text-right">
        لائحة الأسعار
      </h1>

      <div className='flex justify-between items-center w-full'>
        <button onClick={() => handleOpen()} className='w-full mt-8 h-[48px]  bg-main-color text-white border  rounded-lg flex-center main-button'>
          رفع اسعار التطبيق
        </button>
        {/* <button onClick={() => handleOpenAdd()} className='w-2/5 mt-8 h-[48px]  bg-main-color text-white border  rounded-lg flex-center main-button'>
          إضافة سعر مزود  
        </button> */}
      </div>

      <OrdersContext.Provider value={dataPrices}>
        <Tabel.LayoutTable pricesPage={true} handleDownload={handleDownload} title={"الأسعار"}>

          <Tabel.DataTable
            error={error}
            columns={appsPricesColumns}
            pricesProviderPage={true}
            fetchData={fetchData}
            special={true}
            notFound={"لا يوجد اسعار ارفع ملف"}
          />

        </Tabel.LayoutTable>
      </OrdersContext.Provider>
      <ModalPob open={open} handleClose={handleClose}   >
        <form onSubmit={e => handleUpadteProviders(e)} className='flex flex-col gap-4 items-center justify-center'>
          <input value={fileValue} onChange={e => {
            setUnitFile(e.target.files[0])
            setFileSet(true)
            setFileValue(e.target.value)
          }} id="file" type='file' accept='xlsx' className='hidden' />
          <label htmlFor='file' className='flex flex-col items-center cursor-pointer'  >
            <CloudUploadIcon sx={{ fontSize: 40, color: "#282561" }} />
            <p>{fileSet == false ? " اختر ملف اكسل" : unitFile.name}</p>
          </label>
          {fileSet == true && <button type='submit' className='w-fit px-20  h-[48px]  bg-main-color text-white border  rounded-lg flex-center main-button'>
            حفظ التغييرات
          </button>}
        </form>
        <div className={
          clsx(
            'w-full z-50 h-full flex items-center justify-center absolute top-0 left-0 bg-[#ffffff7e]',
            {
              'hidden'
                : submit == false
            }
          )
        }>
          <CircularProgress />
        </div>
      </ModalPob>
      {/* <ModalPob open={openAdd} handleClose={handleCloseAdd} >
        <AddPriceProvider fetchData={fetchData} close={handleCloseAdd} />
      </ModalPob> */}
      <div className={
        clsx(
          'w-full z-50 h-full flex items-center justify-center absolute top-0 left-0 bg-[#ffffff7e]',
          {
            'hidden'
              : submit == false
          }
        )
      }>
        <CircularProgress />
      </div>
    </div>
  )
}

